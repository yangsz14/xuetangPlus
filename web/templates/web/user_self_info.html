{% extends "base.html" %}

{% block title %}学堂Plus{% endblock %}
{% block content %}

    <h1>{{ user.U_RealName }}您的信息</h1>
    <li>
        <div>头像：<img src="{{ BASE_DIR }}/media/{{ user.U_Image }}"/></div>
        {% if request.user == user.user %}
            <label for="changeImage">上传头像</label>
            <input id="changeImage" name="U_Image" type="file" style="position:absolute;clip:rect(0 0 0 0);"/>
        {% endif %}
        {% if request.user == user.user %}
        <div>
            昵称
            <input id="changeNick" type="text" value="{{ user.U_name }}"/>
            <input id="saveNick" type="button" value="修改昵称"/>
        </div>
        {% else %}
            <div>昵称：{{ user.U_name }}</div>
        {% endif %}
        <div>真名：{{ user.U_RealName }}</div>
        <div>院系：{{ user.U_Major }}</div>
        <div>等级：{{ user.U_Level}}</div>
        <div>称号：{{ user.U_Honor}}</div>
        <div>GP币：{{ user.U_GPB }}</div>
        <div>签名：{{ user.U_Description }}</div>
        <a id="helikes" href="/helikes/{{user.id}}/">我的点赞</a>
        <a id="heasks" href="/heasks/{{user.id}}/">我的提问</a>
        <a id="heanswers" href="/heanswers/{{user.id}}/">我的回答</a>
    </li>

    <script type="text/javascript">
    function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie != '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = jQuery.trim(cookies[i]);
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) == (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
    }
    var csrftoken = getCookie('csrftoken');
    function csrfSafeMethod(method) {
        // these HTTP methods do not require CSRF protection
        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }
    $.ajaxSetup({
        beforeSend: function(xhr, settings) {
            if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                xhr.setRequestHeader("X-CSRFToken", csrftoken);
            }
        }
    });

    $(function () {
       $('#changeImage').bind("change", function () {
           if ($(this).prop('files')[0].type.indexOf("image") <= -1 ) {
               alert("请选择图片");
               return;
           }
           var formdata = new FormData();
           formdata.append("file", $(this).prop('files')[0]);
           console.log($(this).prop('files')[0]);
           $.ajax({
               url: "/ajax_change_image/",
               type: "POST",
               data: formdata,
               processData: false,
               contentType: false,
               success: function () {
                   window.location.href = window.location.href;
               }
           });
       })
    });

    $(function () {
        $('#saveNick').bind("click", function () {
            console.log("click");
            var newNick = $('#changeNick').val();
            if (newNick != "") {
                $.ajax({
                    url:'/ajax_change_nickname/',
                    type: 'POST',
                    data: {'newNick': newNick},
                    success: function () {
                        alert("修改成功");
                    }
                })
            }
        })
    });

    </script>
{% endblock %}